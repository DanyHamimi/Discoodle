<!DOCTYPE html>
<html>
   <head>
      <meta charset="UTF-8">
      <title>Discooddle</title>
      <link rel='stylesheet' href='https://codepen.io/tutsplus/pen/WROvdG.css'>
      <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css'>
      <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css'>
      <link rel="stylesheet" href="./style.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <script src='/socket.io/socket.io.js'></script>
      <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
      <script src='https://code.jquery.com/jquery-3.4.1.min.js'></script>
      <style>
         #video-grid {
         display: grid;
         grid-template-columns: repeat(auto-fill, 300px);
         grid-auto-rows: 300px;
         }
         video {
         width: 100%;
         height: 100%;
         object-fit: cover;
         }
      </style>
   </head>
   <body style="background-color: #2c2f33;">
      <div class="content-box"></div>
      <div id="message"></div>
      <div class="container">
         <div class="row-full">
            <div class="col s12 l19">
               <div class="discord-mockup z-depth-3">
                  <div class="items-panel">
                     <div class="items">
                        <div class="item">
                           <div id="item">
                              <div class="circle-logo">
                                 <a href="./home.html">
                                 <img src="./logo.png" />
                                 </a>
                              </div>
                           </div>
                           <button class="guild-add" onclick="addChan()">+</button>
                        </div>
                     </div>
                  </div>
                  <div class="sidebar-panel hide-on-med-and-down" id="module">
                     <div class="header">Projet de Programmation</div>
                     <div id="module2"></div>
                     <div class="user-bas">
                        <div class="circle-logo"><img src="./img/0.png" id="imageid"/></div>
                        <h3 id="name-user-bas"></h3>
                        <script src="profile.js"></script>
                        <script>
                           var profile_link;
                           async function a(){
                             profile_link = await getProfilePictureUrl();
                             user_name = await getUsername();
                             document.getElementById("imageid").src= profile_link;
                             counter = user_name.length;
                             console.log(counter);
                             if (counter>10){
                               user_name = user_name.substring(0,10)+"...";
                             }
                             document.getElementById("name-user-bas").innerHTML = user_name;
                             document.getElementById("hometop").innerHTML = "Discoodog de "+user_name;
                           }
                           a();
                        </script>
                        <button id="button" class="buttonmute"><i class="fa fa-phone"></i></button>
                        <script>var button = document.getElementById('button');
                           i = 0;
                           button.addEventListener('click', function() {
                               if (i == 0){
                                 this.innerHTML = "<i class=\"fa fa-microphone\"></i>";
                                 initVid();
                                 unmuteMic();
                               }
                               else{
                                 this.innerHTML = "<i class=\"fa fa-microphone-slash\"></i>";
                                 leftCall();
                               }
                               i = (i+1)%2;
                           }, false);
                        </script>
                     </div>
                  </div>
                  <div class="messages-panel" id="messages-panel">
                     <div class="test" id="msg-chan">
                        <!-- WebRTC Integration - Sur clic du bouton-->
                        <div class="messages-group hide-unless-show" id="Video">
                           <div class="header">Vidéo chat</div>
                           <div class="messages">
                              <div class="main-video">
                                 <button onclick="initVid(),style.display = 'none'">Appel Vidéo</button>
                                 <div id="video-grid"></div>
                              </div>
                           </div>
                        </div>
                     </div>
                     <div class="msg-input">
                        <form id= "msgform" action="" class="msg-form">
                           <input id = "msg" autocomplete="off" class="msg-input" maxlength="2000" placeholder="Écrivez votre message ici !"/>
                        </form>
                        <form method="post" enctype="multipart/form-data" action="/upload">
                           <label for="file-upload" class="custom-file-upload">
                           +
                           </label>
                           <input id="file-upload" type="file" name="file" accept=".jpg, .jpeg, .png" onchange="this.form.submit()">
                           <input type="hidden" id="uname" value="rayan" name="uname">
                        </form>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div id="result"></div>
      <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script><script  src="./script.js"></script>
      <script>
        var currentChannel;
         var a = 69;
           function get(name){
               var url = window.location.search;
               var num = url.search(name);
               var namel = name.length;
               var frontlength = namel+num+1; //length of everything before the value 
               var front = url.substring(0, frontlength);  
               url = url.replace(front, "");  
               num = url.search("&");
               if(num>=0) return url.substr(0,num); 
               if(num<0)  return url;             
           }
         
         
           function addChan(){
             a++;
             var res = String.fromCharCode(a);
             document.getElementById('item').insertAdjacentHTML('beforeEnd','<button class="guild-add">' + res + '</button>');
           }
           
           function enableEmo(elem) {
             document.querySelector('#msg').value += elem.textContent;
           }
         
           function display(elemt) {
             var x = document.getElementById(elemt);
             currentChannel = elemt;
             document.getElementById('module2').innerHTML = "";
             //document.getElementById('module2').innerHTML = '<div class="header">Projet de Programmation</div>';
             if (!x){
               var test = "SELECT * FROM `cours` WHERE libelle_cours = "+elemt;
               //console.log(test);
               socket.emit('sql-select', "SELECT * FROM `cours` WHERE libelle_cours = "+'"'+elemt+'"', (result) =>{
                //console.log(result);
                 socket.emit('sql-select', "SELECT * FROM `modules` WHERE id_cours = "+'"'+result[0].id_cours+'"', (res) =>{
                   console.log(res);
                   console.log(res.length)
         
                   document.getElementById('module2').insertAdjacentHTML('beforeEnd','<div class="items" style="display:block" id="'+result[i].libelle_cours+'"><a id="'+result[i].libelle_cours+'test" href="#"></a></div>');
                     var j = 0;
                     for (let i = 0; i < res.length; i++) {
                       var toto = result[0].libelle_cours+"test";
                       console.log("'"+res[i].libelle_module+"'");
                       var p = document.contains(document.getElementById(res[i].libelle_module));
                       document.getElementById(toto).insertAdjacentHTML('beforeEnd','<div class="item trigger-group" id="testtest" data="'+ res[i].libelle_module+ '">'+ res[i].libelle_module+ '</div>');
                       if (p === false) {
                         document.getElementById('msg-chan').insertAdjacentHTML('beforeEnd','<div class="messages-group hide-unless-show" id="'+res[i].libelle_module+'"><div class="header">'+res[i].libelle_module+'</div><div class="messages" id = "'+res[i].libelle_module+"0"+'"></div></div>');
                       }
                       
                       socket.emit('join-channel',res[i].libelle_module+"0");
                     }
                     //document.getElementById(toto).insertAdjacentHTML('beforeEnd','<div class="messages-group hide-unless-show" id="'+res[0].id_cours+'"><div class="header">video'+result[0].id_cours+'</div><div class="messages" id = "'+res[i].libelle_module+"0"+'"></div></div>');
                   });
                     
               })
             }
           } 
             var t;
             async function b(uid){
               t = await getOtherProfilePictureUrl(uid);
               console.log(t);
               return t;
             }
         
           $(function (){
           
             var socket = io();
               const def = "Utilisateur";
               const name = "test";
               
         
               let t = new Promise(function(resolve, reject) {
                 //var classe;
                 socket.emit('sql-select', "SELECT class FROM `users` WHERE id_user = "+getCookie("uid"), (result) =>{
                 console.log("classe :"+getCookie("uid"));
                 //classe = result[0].class;
                 //console.log(classe);
                 resolve(result[0].class);
                 })              
               });
               t.then((classe)=>{
                 socket.emit('sql-select', "SELECT * FROM `cours` WHERE id_classe =" +classe, (result) =>{
                 console.log(classe+"here");
                 var test = "test";
                 for (let i = 0; i < result.length; i++) {
                   document.getElementById('item').insertAdjacentHTML('beforeEnd','<button class="guild-add" onclick=\'display("'+result[i].libelle_cours+'")\'>' + result[i].libelle_cours + '</button>');
                 }
               })
               })
               socket.emit('user-created',name);
               socket.emit('checklog');
               
               
               
                 
               
             	
               
               socket.emit('user-created',name);
               socket.emit('checklog');
               var idArray = [];
               $('.messages').each(function () {
                 idArray.push(this.id);
               });
         
               for (const element of idArray) {
                   socket.emit('join-channel',element);
               }
               
               if(localStorage.getItem("nom") !== null){
                 var tabhome = document.getElementById(localStorage.getItem("nom"));
                 if(tabhome.style.display = "none"){
                   display(localStorage.getItem("nom"));
                   console.log(localStorage.getItem("nom"));
                   localStorage.removeItem("nom");
                 }
               }
               socket.on('checklog',()=>{
                 console.log('FAIT');
                 window.location.href = "log.html"
               })
               document.getElementById("uname").setAttribute('value',name);  
               var username = name;
               $("#msgform").submit(function(e) {
         
                   e.preventDefault(); // Pour pas que la page se recharge
                   console.log($("#msg").length);
                   socket.emit("MessageSend",username, $("#msg").val(),new Date(),defaultId+0,getCookie("uid"),profile_link); //Envoyer au socket la val de #msg
                   $("#msg").val(""); // On vide pr pouvoir renvoyer un msg 
         
                   element = document.getElementById('msg-chan');
               element.scrollTop = element.scrollHeight;
                   return false;
               });
              
               socket.on('MessageSend', function(name,msg,hour,channel1,usid,prfPic){
                 if (channel1 == defaultId+'0'){
                   var node = document.getElementById(defaultId+'0');
                   console.log(defaultId);
                   node.insertAdjacentHTML('beforeend', '<div class="message"> <div class="icon"><img class="responsive-img" src="'+prfPic+'"/></div> <div class="body"> <div class="user-name">'+name+'</div><div class="hour">'+hour+'</div> <div class="content">'+msg+'</div> </div> </div>');
                   element = document.getElementById('msg-chan');
                   element.scrollTop = element.scrollHeight;
                 }
               });
         
               socket.on('OldSend', function(name,msg,hour,channel,prPic){
                 element = document.getElementById('msg-chan');
             element.scrollTop = element.scrollHeight;
                 var node = document.getElementById(channel);
                 if(node != null){
                   node.insertAdjacentHTML('beforeend', '<div class="message"> <div class="icon"><img class="responsive-img" src="'+prPic+'"/></div> <div class="body"> <div class="user-name">'+name+'</div><div class="hour">'+hour+'</div> <div class="content">'+msg+'</div> </div> </div>');
                 }
               })
         
               socket.on('ImageSend', function(name,img){
                 element = document.getElementById('msg-chan');
             element.scrollTop = element.scrollHeight;
                 var node = document.getElementById(defaultId+'0');
                 console.log(defaultId);
                 node.insertAdjacentHTML('beforeend', '<div class="message"><div class="icon"><img class="responsive-img" src="./ProfilDefault.png"/></div> <div class="body"> <div class="user-name">'+name+'</div> <div class="content"> <img src="'+img+'" style="max-width: 500px;"/></div> </div> </div>');
               });
           });
      </script>
      <script>
         const mySocket = io('/')
         var button = document.getElementById('button');
         button.addEventListener('click', function() {
           if(currentChannel) {
             this.innerHTML = "<i class=\"fa fa-microphone\"></i>";
             var myRoomId = currentChannel;
             var a = "SELECT username FROM users WHERE id_user = " + getCookie("uid");
             var username;
             mySocket.emit("sql-select", a, (response) => {
               console.log(response +" this is resposnse")
                 username = response[0].username;
                 let roomUrl = "video.html?room=" + myRoomId + "&userId=" + username;
                 window.open(roomUrl); 
             })
            }
             
           })
           
      </script>
   </body>
</html>