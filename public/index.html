<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Discoodle</title>
    <link rel='stylesheet' href='https://codepen.io/tutsplus/pen/WROvdG.css'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css'><link rel="stylesheet" href="./style.css">
  <script src='/socket.io/socket.io.js'></script>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script src='https://code.jquery.com/jquery-3.4.1.min.js'></script>
  <style>
    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 300px);
      grid-auto-rows: 300px;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
  

</head>
<body style="background-color: #2c2f33;">
    <div class="content-box"></div>
    <div id="message"></div>
    
    <div class="container">
        <div class="row-full">
          <div class="col s12 l19">
            <div class="discord-mockup z-depth-3">
              <div class="items-panel">
                <div class="items">
                  <div class="item">
                    <div id="item">
                      <button class="guild-add" id="btn" onclick='display("OL")'>OL</button>
                      <button class="guild-add" onclick='display("C")'>C</button>
                      <button class="guild-add" onclick='display("EA")'>EA</button>
                      <button class="guild-add" onclick='display("M")'>M</button>
                    </div>  
                    <button class="guild-add" onclick="addChan()">+</button>
                  </div>
                </div>
              </div>
          
              <div class="sidebar-panel hide-on-med-and-down">
                <div class="header">Projet de Programmation</div>
                <div class="items" style="display:none" id="OL"><a href="#">
                    <div class="item trigger-group" data="Progra">Programmation</div>
                    <div class="item trigger-group" data="ea4">EA4</div>
                    <div class="item trigger-group" data="Stats">Stats</div>
                    <div class="item trigger-group" data="Video">Appel Vidéo</div>
                </a></div>
                <div class="items" style="display:none" id="M"><a href="#">
                  <div class="item trigger-group" data="Progra">Programmation</div>
                  <div class="item trigger-group" data="Cours M1">Cours M1</div>
                  <div class="item trigger-group" data="Cours M2">Cours M2</div>
                  <div class="item trigger-group" data="Video">Appel Vidéo</div>
                </a></div>
                <div class="items" style="display:none" id="C"><a href="#">
                  <div class="item trigger-group" data="Progra">Programmation</div>
                  <div class="item trigger-group" data="Cours C1">Cours C1</div>
                  <div class="item trigger-group" data="Cours C2">Cours C2</div>
                  <div class="item trigger-group" data="Video">Appel Vidéo</div>
                </a></div>
                <div class="items" style="display:none" id="EA"><a href="#">
                  <div class="item trigger-group" data="Progra">Programmation</div>
                  <div class="item trigger-group" data="Cours EA1">Cours EA1</div>
                  <div class="item trigger-group" data="Cours EA2">Cours EA2</div>
                  <div class="item trigger-group" data="Video">Appel Vidéo</div>
                </a></div>
              </div>
               
              <div class="messages-panel" id="messages-panel">
                <div class="test" id="test">
                  <div class="messages-group hide-unless-show" id="Progra">
                    <div class="header">Général</div>
                    <div class="messages" id = "Progra0">
                    </div>
                  </div>
                  <div class="messages-group hide-unless-show" id="ea4">
                    <div class="header">ea4</div>
                    <div class="messages" id = "ea40">
                    </div>
                  </div>
                  <div class="messages-group hide-unless-show" id="Cours C1">
                    <div class="header">Cours C1</div>
                    <div class="messages" id = "Cours C10">
                    </div>
                  </div>
                  <div class="messages-group hide-unless-show" id="Cours C2">
                    <div class="header">Cours C2</div>
                    <div class="messages" id = "Cours C20">
                    </div>
                  </div>
                  <div class="messages-group hide-unless-show" id="Cours EA1">
                    <div class="header">Cours EA1</div>
                    <div class="messages" id = "Cours EA10">
                    </div>
                  </div>
                  <div class="messages-group hide-unless-show" id="Cours EA2">
                    <div class="header">Cours EA2</div>
                    <div class="messages" id = "Cours EA20">
                    </div>
                  </div>
                  <div class="messages-group hide-unless-show" id="Cours M1">
                    <div class="header">Cours M1</div>
                    <div class="messages" id = "Cours M10">
                    </div>
                  </div>
                  <div class="messages-group hide-unless-show" id="Cours M2">
                    <div class="header">Cours M2</div>
                    <div class="messages" id = "Cours M20">
                    </div>
                  </div>

                  <div class="messages-group hide-unless-show" id="Stats">
                    <div class="header">Stats</div>
                    <div class="messages">
                  </div>                
                </div>
                
               
                  

                  <!-- WebRTC Integration - Sur clic du bouton-->
                  <div class="messages-group hide-unless-show" id="Video">
                    <div class="header">Vidéo chat</div>
                    <div class="messages">
                      <div class="main-video">
                        <button onclick="initVid()">Appel Vidéo</button>
                        <div id="video-grid"></div>
                      </div>
                    </div>
                  </div>


                </div>
                <div class="msg-input">
                  <form id= "msgform" action="" class="msg-form">
                    <a id="smiley" title="smiley" href="#" onclick="enableEmo(this, event)" >&#128515;</a>
                    <a id="feu" title="feu" href="#" onclick="enableEmo(this, event)" >&#128293;</a>
                    <input id = "msg" autocomplete="off" class="msg-input"/>
                  </form>
                  <form method="post" enctype="multipart/form-data" action="/upload">
                    <label for="file-upload" class="custom-file-upload">
                       +
                  </label>
                    <input id="file-upload" type="file" name="file" accept=".jpg, .jpeg, .png" onchange="this.form.submit()"">
                    <input type="hidden" id="uname" value="rayan" name="uname">
                  </form>
                </div>
              </div>
             
            </div>
            
          </div>
        </div>
    </div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script><script  src="./script.js"></script><script  src="./video.js"></script>
    <script>
      var a = 69;
        function get(name){
            var url = window.location.search;
            var num = url.search(name);
            var namel = name.length;
            var frontlength = namel+num+1; //length of everything before the value 
            var front = url.substring(0, frontlength);  
            url = url.replace(front, "");  
            num = url.search("&");
            if(num>=0) return url.substr(0,num); 
            if(num<0)  return url;             
        }


        function addChan(){
          a++;
          var res = String.fromCharCode(a);
          document.getElementById('item').insertAdjacentHTML('beforeEnd','<button class="guild-add">' + res + '</button>');
        }

        function enableEmo(elem) {
          document.querySelector('#msg').value += elem.textContent;
        }

        function display(elemt) {
          var x = document.getElementById(elemt);
          var ea = document.getElementById("EA");
          var ol = document.getElementById("OL");
          var c = document.getElementById("C");
          var m = document.getElementById("M");
          
          if (x.style.display === "none") {
            if(x === ea){
              ol.style.display = "none";
              c.style.display = "none";
              m.style.display = "none";  
            }
            if(x === ol){
              ea.style.display = "none";
              c.style.display = "none";
              m.style.display = "none";  
            }
            if(x === m){
              ea.style.display = "none";
              c.style.display = "none";
              ol.style.display = "none";  
            }
            if(x === c){
              ea.style.display = "none";
              ol.style.display = "none";
              m.style.display = "none";  
            }
            x.style.display = "block";            
          } else {
            x.style.display = "none";
          }
        } 

       

        $(function (){
            var socket = io();
            const def = "Utilisateur";
            const name = "test";
            socket.emit('user-created',name);
            socket.emit('checklog');
            socket.on('checklog',()=>{
              console.log('FAIT');
              window.location.href = "log.html"
            })
            document.getElementById("uname").setAttribute('value',name);  
            var username = name;
            $("#msgform").submit(function(e) {
                e.preventDefault(); // Pour pas que la page se recharge
                socket.emit("MessageSend",username, $("#msg").val()) //Envoyer au socket la val de #msg
                $("#msg").val(""); // On vide pr pouvoir renvoyer un msg 

                element = document.getElementById('test');
				        element.scrollTop = element.scrollHeight;
                return false;
            });
         
            socket.on('MessageSend', function(name,msg,hour){
              element = document.getElementById('test');
				      element.scrollTop = element.scrollHeight;

              var node = document.getElementById(defaultId+'0');
              console.log(defaultId);
              node.insertAdjacentHTML('beforeend', '<div class="message"> <div class="icon"><img class="responsive-img" src="./ProfilDefault.png"/></div> <div class="body"> <div class="user-name">'+name+'</div><div class="hour">'+hour+'</div> <div class="content">'+msg+'</div> </div> </div>');

            });

            socket.on('ImageSend', function(name,img){
              element = document.getElementById('test');
				      element.scrollTop = element.scrollHeight;
              var node = document.getElementById(defaultId+'0');
              console.log(defaultId);
              node.insertAdjacentHTML('beforeend', '<div class="message"> <div class="icon"><img class="responsive-img" src="./ProfilDefault.png"/></div> <div class="body"> <div class="user-name">'+name+'</div> <div class="content"> <img src="'+img+'" style="max-width: 500px;"/></div> </div> </div>');
            });
        });
    </script>
    
</body>
</html>